build:
    image: kradalby/ci-tox:latest
    pull: true
    environment:
      - DJANGO_SETTINGS_MODULE=init_django.settings.dev
    commands:
      - tox

notify:
  email:
    from: drone@fap.no
    host: mail.ntnu.fap.no
    port: 25
    recipients:
      - kradalby@kradalby.no
    when:
        branch: master

publish:
  docker:
    registry: registry.fap.no
    repo: aspargesgaarden/aspargesgaarden
    tag: latest
    insecure: true
    when:
        branch: master
    load: docker/image.tar
    save:
      destination: docker/image.tar
      tag: latest

deploy:
  ssh:
    host:
     - primeape.terra.fap.no
    user: root
    port: 22
    sleep: 2
    commands:
      - docker pull registry.fap.no/aspargesgaarden/aspargesgaarden:latest
      - docker-compose -f /srv/docker/aspargesgaarden/docker-compose.yml down
      - docker-compose -f /srv/docker/aspargesgaarden/docker-compose.yml up -d
    when:
        branch: master
